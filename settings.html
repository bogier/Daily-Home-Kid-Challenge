<!-- Daily Home Kid Challenge — settings v4.6.18+3 — build 2025-09-26 -->
<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="utf-8"/>
<title>Paramètres - Daily Home Kid Challenge</title>
<meta content="width=device-width, initial-scale=1.0" name="viewport"/>
<link href="style.css?v=4.8.0" rel="stylesheet"/>
</head>
<body>
<div id="header-container"></div>

<main id="mainContent">
<h1 class="page-title">⚙️ Paramètres</h1>
<div class="calendar">
  <button id="btnPrev" class="arrow-btn" onclick="prevChildSettings()">◀</button>
  <h2 id="childTitle">Enfant …</h2>
  <button id="btnNext" class="arrow-btn" onclick="nextChildSettings()">▶</button>
</div>
<div id="childrenSettings"></div>
<div class="pagination" id="pagination"></div>
<div class="actions">
  <button class="success-btn" onclick="ajouterEnfant()">➕ Ajouter un enfant</button>
  <button class="warning-btn" onclick="importerEnfant()">📥 Importer un enfant</button>
  <button class="warning-btn" onclick="importExample()">📂 Importer l’exemple</button>
  <button class="success-btn" onclick="sauver()">💾 Enregistrer</button>
  <button class="danger-btn" onclick="resetAll()">🔄 Réinitialiser enfants</button>
  <button class="warning-btn" onclick="exporterEnfant(currentChild)">📤 Exporter cet enfant</button>
  <button class="danger-btn" onclick="window.location.href='purge.html'">💣 Purge totale</button>
</div>
</main>
<footer>⚡ Version V4.8</footer>
<script>

if(window.matchMedia('(prefers-color-scheme: dark)').matches)document.body.classList.add("dark");
if(localStorage.getItem("darkMode")==="true")document.body.classList.add("dark");
function toggleDarkMode(){document.body.classList.toggle("dark");localStorage.setItem("darkMode",document.body.classList.contains("dark"));}
function toggleBase(cIdx, el){const block=document.getElementById("base-block-"+cIdx);if(block){block.classList.toggle("hidden");el.classList.toggle("collapsed");}}
let children=JSON.parse(localStorage.getItem("children"))||[];
children=(children||[]).map(c=>{if(!c.settings)c.settings={};if(!c.settings.childName)c.settings.childName="";
if(!c.settings.rewardLow)c.settings.rewardLow="";if(!c.settings.rewardHigh)c.settings.rewardHigh="";
if(!c.settings.thresholdLow&&c.settings.thresholdLow!==0)c.settings.thresholdLow=30;
if(!c.settings.thresholdHigh&&c.settings.thresholdHigh!==0)c.settings.thresholdHigh=50;
if(!c.settings.rewards)c.settings.rewards={};if(!c.tasks)c.tasks=[];
c.tasks=c.tasks.map(t=>{if(!t.name)t.name="";if(!t.weights)t.weights=[1,1,1,1,1,0,0];return t;});return c;});
let currentChild=0;
function prevChildSettings(){if(currentChild>0){currentChild--;render();}}
function nextChildSettings(){if(currentChild<children.length-1){currentChild++;render();}}
function goToChild(idx){currentChild=idx;render();}
let _saveTimer=null;
function autoSave(){clearTimeout(_saveTimer);_saveTimer=setTimeout(()=>{localStorage.setItem("children",JSON.stringify(children));},300);}
function sauver(){try{localStorage.setItem("children",JSON.stringify(children));alert("✅ Paramètres enregistrés");}catch(e){alert("❌ Erreur : "+e.message);}}
function ajouterEnfant(){children.push({settings:{childName:"Nouvel enfant",rewardLow:"",rewardHigh:"",thresholdLow:30,thresholdHigh:50,rewards:{}},tasks:[]});currentChild=children.length-1;autoSave();render();}
function supprimerEnfant(idx){if(confirm("Supprimer cet enfant ?")){children.splice(idx,1);if(currentChild>=children.length)currentChild=children.length-1;autoSave();render();}}
function resetAll(){if(confirm("⚠️ Réinitialiser tous les enfants ?")){children=[];currentChild=0;autoSave();render();}}
function ajouterTache(cIdx){children[cIdx].tasks.push({name:"",weights:[1,1,1,1,1,0,0]});autoSave();render();}
function supprimerTache(cIdx,tIdx){children[cIdx].tasks.splice(tIdx,1);autoSave();render();}
function moveTask(cIdx,tIdx,dir){const tasks=children[cIdx].tasks;const newIdx=tIdx+dir;if(newIdx<0||newIdx>=tasks.length)return;const[moved]=tasks.splice(tIdx,1);tasks.splice(newIdx,0,moved);autoSave();render();}
function ajouterReward(cIdx) {
  const now = new Date();
  // Calcule la semaine ISO (méthode du jeudi)
  const d = new Date(Date.UTC(now.getFullYear(), now.getMonth(), now.getDate()));
  const day = d.getUTCDay() === 0 ? 7 : d.getUTCDay(); // lundi=1, dimanche=7
  d.setUTCDate(d.getUTCDate() + 4 - day);
  const year = d.getUTCFullYear();
  const yearStart = new Date(Date.UTC(year, 0, 1));
  const week = Math.ceil((((d - yearStart) / 86400000) + 1) / 7);

  const defaultKey = `${week}-${year}`;
  const key = prompt(`Clé semaine (ex: on est semaine ${defaultKey}) :`, defaultKey);
  if (key) {
    if (!children[cIdx].settings.rewards) children[cIdx].settings.rewards = {};
    children[cIdx].settings.rewards[key] = { low: "", high: "" };
    autoSave();
    render();
  }
}
function supprimerReward(cIdx,key){delete children[cIdx].settings.rewards[key];autoSave();render();}
function exporterEnfant(idx){const enfant=children[idx];if(!enfant){alert("❌ Aucun enfant");return;}const dataStr="data:text/json;charset=utf-8,"+encodeURIComponent(JSON.stringify(enfant,null,2));const dl=document.createElement("a");dl.setAttribute("href",dataStr);dl.setAttribute("download",(enfant.settings.childName||"enfant")+".json");dl.click();}
function importerEnfant(){const input=document.createElement("input");input.type="file";input.accept="application/json";input.onchange=e=>{const file=e.target.files[0];if(!file)return;const reader=new FileReader();reader.onload=evt=>{try{const enfant=JSON.parse(evt.target.result);children.push(enfant);currentChild=children.length-1;autoSave();render();alert("✅ Import réussi");}catch(err){alert("❌ Fichier invalide : "+err.message);}};reader.readAsText(file);};input.click();}
function setReward(cIdx,type,value){children[cIdx].settings[type]=value;autoSave();}
function setTask(cIdx,tIdx,value){children[cIdx].tasks[tIdx].name=value;autoSave();}
function setWeight(cIdx,tIdx,dayIdx,value){children[cIdx].tasks[tIdx].weights[dayIdx]=Number(value)||0;autoSave();}
function setWeekReward(cIdx,key,type,value){children[cIdx].settings.rewards[key][type]=value;autoSave();}

function render(){
  const container=document.getElementById("childrenSettings");
  const pagination=document.getElementById("pagination");
  container.innerHTML="";pagination.innerHTML="";
  if(children.length===0){container.innerHTML="<p>⚠️ Aucun enfant défini</p>";document.getElementById("childTitle").textContent="Aucun enfant";return;}
  const child=children[currentChild];
  document.getElementById("childTitle").textContent=child.settings.childName||"Nouvel enfant";
  const card=document.createElement("div");card.className="child-card";
  card.innerHTML=`
    <div class="section">
      <h4 class="toggle-section collapsed" onclick="toggleBase(${currentChild}, this)">👤 Paramètres de base et par défaut</h4>
      <div id="base-block-${currentChild}" class="hidden">
        <div class="form-row"><label>Nom/Prénom</label><input type="text" value="${child.settings.childName||""}" oninput="setReward(${currentChild},'childName',this.value)"></div>
        <div class="form-row default-thresholds form-separator"><label>🎯 Seuil 1 (%)</label><input type="number" min="0" max="100" value="${child.settings.thresholdLow??30}" oninput="setReward(${currentChild},'thresholdLow',this.value)"><label>🎯 Seuil 2 (%)</label><input type="number" min="0" max="100" value="${child.settings.thresholdHigh??50}" oninput="setReward(${currentChild},'thresholdHigh',this.value)"></div>
        <div class="form-row default-rewards form-separator"><label>🎁 Gain 1</label><input type="text" value="${child.settings.rewardLow||""}" placeholder="Cadeau seuil 1" oninput="setReward(${currentChild},'rewardLow',this.value)"><label>🎁 Gain 2</label><input type="text" value="${child.settings.rewardHigh||""}" placeholder="Cadeau seuil 2" oninput="setReward(${currentChild},'rewardHigh',this.value)"></div>
      </div>
    </div>
    <div class="section"><h4>🎁 Récompenses par semaine</h4><div id="rewards-${currentChild}"></div><button class="success-btn" onclick="ajouterReward(${currentChild})">➕ Ajouter une semaine</button></div>
    <div class="section"><h4>Tâches</h4><div id="tasks-${currentChild}"></div><div class="form-row"><button class="success-btn" onclick="ajouterTache(${currentChild})">➕ Ajouter une tâche</button><button class="danger-btn" onclick="supprimerEnfant(${currentChild})">🗑 Supprimer cet enfant</button></div></div>`;
  container.appendChild(card);
  const rewardsDiv=card.querySelector("#rewards-"+currentChild);const rewards=child.settings.rewards||{};
  if(Object.keys(rewards).length===0){rewardsDiv.innerHTML="<p>ℹ️ Aucune récompense hebdo définie</p>";}
  else{for(const key in rewards){const r=rewards[key];rewardsDiv.innerHTML+=`<div class="reward-week"><input type="text" value="${key}" disabled><input type="text" value="${r.low||""}" placeholder="Palier 1" oninput="setWeekReward(${currentChild},'${key}','low',this.value)"><input type="text" value="${r.high||""}" placeholder="Palier 2" oninput="setWeekReward(${currentChild},'${key}','high',this.value)"><button class="danger-btn" onclick="supprimerReward(${currentChild},'${key}')">🗑</button></div>`;}}
  const tasksDiv=card.querySelector("#tasks-"+currentChild);
  if(!child.tasks||child.tasks.length===0){tasksDiv.innerHTML="<p>⚠️ Aucune tâche définie</p>";}
  else{child.tasks.forEach((t,tIdx)=>{tasksDiv.innerHTML+=`<div class="task-block"><div class="form-row task-row"><input type="text" value="${t.name}" oninput="setTask(${currentChild},${tIdx},this.value)"><button onclick="moveTask(${currentChild},${tIdx},-1)">⬆️</button><button onclick="moveTask(${currentChild},${tIdx},1)">⬇️</button><button class="danger-btn" onclick="supprimerTache(${currentChild},${tIdx})">🗑</button></div><div class="weights-grid">${["Lun","Mar","Mer","Jeu","Ven","Sam","Dim"].map((d,dayIdx)=>`<label>${d}<input type="number" min="0" value="${t.weights?.[dayIdx]??0}" oninput="setWeight(${currentChild},${tIdx},${dayIdx},this.value)"></label>`).join("")}</div></div>`;});}
  children.forEach((c,idx)=>{const item=document.createElement("div");item.className="page-item"+(idx===currentChild?" active":"");item.onclick=()=>goToChild(idx);item.innerHTML=`<div class="dot"></div><span>${c.settings.childName||`Enfant ${idx+1}`}</span>`;pagination.appendChild(item);});
}
render();

async function importExample() {
  try {
    const response = await fetch("exemple.json", { cache: "no-store" });
    if (!response.ok) throw new Error("Fichier exemple introuvable");

    const enfant = await response.json();

    // Récupère la liste actuelle
    let children = JSON.parse(localStorage.getItem("children")) || [];

    // Ajoute l'enfant d'exemple à la liste
    children.push(enfant);

    // Sauvegarde et recharge
    localStorage.setItem("children", JSON.stringify(children));
    alert("✅ Exemple importé avec succès !");
    location.reload();

  } catch (err) {
    alert("⚠️ Erreur lors de l’import de l’exemple : " + err.message);
  }
}
</script>
<script>
  // Charger le header externe
  fetch("header.html")
    .then(res => res.text())
    .then(html => {
      document.getElementById("header-container").innerHTML = html;
    });
</script>

</body>
</html>