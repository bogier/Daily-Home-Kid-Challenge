<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="utf-8"/>
<title>Param√®tres - Daily Home Kid Challenge</title>
<meta content="width=device-width, initial-scale=1.0" name="viewport"/>
<link href="style.css?v=4.8.0" rel="stylesheet"/>
<style>
.form-separator {border-top:none;margin-top:0.8rem;padding-top:0.8rem;}
:not(.hidden) > .form-separator {border-top:1px solid #4CAF50;}
.toggle-section::after{content:"‚ñº";font-size:0.8rem;margin-left:0.5rem;transition:transform 0.3s;}
.toggle-section.collapsed::after{transform:rotate(-90deg);}
.hidden{display:none;}
/* Fl√®ches & boutons */
.calendar {display:flex;align-items:center;justify-content:center;gap:1rem;}
.calendar h2 {margin:0;font-size:1.5rem;font-weight:600;}
.arrow-btn {background-color:#4CAF50;color:white;border:2px solid #388E3C;border-radius:50%;width:40px;height:40px;font-size:1.2rem;cursor:pointer;transition:background-color 0.3s,transform 0.2s;}
.arrow-btn:hover {background-color:#45a049;transform:scale(1.1);}
.danger-btn {background-color:#e53935;color:#fff;border:2px solid #b71c1c;border-radius:50px;padding:0.5rem 1.5rem;cursor:pointer;font-weight:600;transition:background-color 0.3s,transform 0.2s;}
.danger-btn:hover {background-color:#c62828;transform:scale(1.05);}
.warning-btn {background-color:#FFEB3B;color:#000;border:2px solid #FBC02D;border-radius:50px;padding:0.5rem 1.5rem;cursor:pointer;font-weight:600;transition:background-color 0.3s,transform 0.2s;}
.warning-btn:hover {background-color:#FDD835;transform:scale(1.05);}
.success-btn {background-color:#4CAF50;color:#fff;border:2px solid #388E3C;border-radius:50px;padding:0.5rem 1.5rem;cursor:pointer;font-weight:600;transition:background-color 0.3s,transform 0.2s;}
.success-btn:hover {background-color:#45a049;transform:scale(1.05);}
/* R√©compenses par semaine */
.reward-week {display:flex;align-items:center;gap:0.5rem;margin-bottom:0.5rem;}
.reward-week input {flex:1;padding:0.4rem;border:1px solid #ccc;border-radius:6px;min-width:0;}
.reward-week button {flex-shrink:0;width:42px;height:42px;font-size:1.2rem;display:flex;align-items:center;justify-content:center;}
</style>
</head>
<body>
<header>
<div class="nav-left">
<nav id="navMenu" style="display:flex;">
  <a aria-label="Accueil" href="index.html">
    <svg aria-hidden="true" class="icon" viewBox="0 0 24 24"><path d="M3 10.5L12 3l9 7.5"></path><path d="M5 10v10h14V10"></path><path d="M9 20v-6h6v6"></path></svg>
  </a>
  <a aria-label="Param√®tres" href="settings.html">
    <svg aria-hidden="true" class="icon" viewBox="0 0 24 24"><circle cx="12" cy="12" r="3"></circle><path d="M19.4 15a7.8 7.8 0 0 0 .1-2l2-1.1-1.4-2.4-2.2.6a7.8 7.8 0 0 0-1.7-1l-.3-2.3h-2.8l-.3 2.3a7.8 7.8 0 0 0-1.7 1l-2.2-.6L2.5 12l2 1.1a7.8 7.8 0 0 0 .1 2L2.5 16l1.4 2.4 2.2-.6a7.8 7.8 0 0 0 1.7 1l.3 2.2h2.8l.3-2.2a7.8 7.8 0 0 0 1.7-1l2.2.6 1.4-2.4-2-.9Z"></path></svg>
  </a>
  <a aria-label="√Ä propos" href="about.html">
    <svg aria-hidden="true" class="icon" viewBox="0 0 24 24"><circle cx="12" cy="12" r="10"></circle><line x1="12" x2="12" y1="8" y2="8"></line><line x1="12" x2="12" y1="12" y2="17"></line></svg>
  </a>
  <a aria-label="Installer l‚Äôapp" href="install.html">
    <svg aria-hidden="true" class="icon" viewBox="0 0 24 24"><path d="M12 3v10"></path><polyline points="8 11 12 15 16 11"></polyline><path d="M4 20h16"></path></svg>
  </a>
</nav>
</div>
<button class="toggle-dark" onclick="toggleDarkMode()">
  <span aria-hidden="true" class="icon-sun">
    <svg aria-hidden="true" class="icon" viewBox="0 0 24 24"><circle cx="12" cy="12" r="4"></circle><line x1="12" x2="12" y1="2" y2="5"></line><line x1="12" x2="12" y1="19" y2="22"></line><line x1="2" x2="5" y1="12" y2="12"></line><line x1="19" x2="22" y1="12" y2="12"></line><line x1="4.2" x2="6.3" y1="4.2" y2="6.3"></line><line x1="17.7" x2="19.8" y1="17.7" y2="19.8"></line><line x1="17.7" x2="19.8" y1="6.3" y2="4.2"></line><line x1="4.2" x2="6.3" y1="19.8" y2="17.7"></line></svg>
  </span>
  <span aria-hidden="true" class="icon-moon">
    <svg aria-hidden="true" class="icon" viewBox="0 0 24 24"><path d="M21 12.8A9 9 0 1 1 11.2 3 7 7 0 0 0 21 12.8z"></path></svg>
  </span>
</button>
</header>
<main id="mainContent">
<h1 class="page-title">‚öôÔ∏è Param√®tres</h1>
<div class="calendar">
  <button id="btnPrev" class="arrow-btn" onclick="prevChildSettings()">‚óÄ</button>
  <h2 id="childTitle">Enfant ‚Ä¶</h2>
  <button id="btnNext" class="arrow-btn" onclick="nextChildSettings()">‚ñ∂</button>
</div>
<div id="childrenSettings"></div>
<div class="pagination" id="pagination"></div>
<div class="actions">
  <button class="success-btn" onclick="ajouterEnfant()">‚ûï Ajouter un enfant</button>
  <button class="warning-btn" onclick="importerEnfant()">üì• Importer un enfant</button>
  <button class="success-btn" onclick="sauver()">üíæ Enregistrer</button>
  <button class="danger-btn" onclick="resetAll()">üîÑ R√©initialiser enfants</button>
  <button class="warning-btn" onclick="exporterEnfant(currentChild)">üì§ Exporter cet enfant</button>
  <button class="danger-btn" onclick="window.location.href='purge.html'">üí£ Purge totale</button>
</div>
</main>
<footer>‚ö° Version V4.8</footer>
<script>

if(window.matchMedia('(prefers-color-scheme: dark)').matches)document.body.classList.add("dark");
if(localStorage.getItem("darkMode")==="true")document.body.classList.add("dark");
function toggleDarkMode(){document.body.classList.toggle("dark");localStorage.setItem("darkMode",document.body.classList.contains("dark"));}
function toggleBase(cIdx, el){const block=document.getElementById("base-block-"+cIdx);if(block){block.classList.toggle("hidden");el.classList.toggle("collapsed");}}
let children=JSON.parse(localStorage.getItem("children"))||[];
children=(children||[]).map(c=>{if(!c.settings)c.settings={};if(!c.settings.childName)c.settings.childName="";
if(!c.settings.rewardLow)c.settings.rewardLow="";if(!c.settings.rewardHigh)c.settings.rewardHigh="";
if(!c.settings.thresholdLow&&c.settings.thresholdLow!==0)c.settings.thresholdLow=30;
if(!c.settings.thresholdHigh&&c.settings.thresholdHigh!==0)c.settings.thresholdHigh=50;
if(!c.settings.rewards)c.settings.rewards={};if(!c.tasks)c.tasks=[];
c.tasks=c.tasks.map(t=>{if(!t.name)t.name="";if(!t.weights)t.weights=[1,1,1,1,1,0,0];return t;});return c;});
let currentChild=0;
function prevChildSettings(){if(currentChild>0){currentChild--;render();}}
function nextChildSettings(){if(currentChild<children.length-1){currentChild++;render();}}
function goToChild(idx){currentChild=idx;render();}
let _saveTimer=null;
function autoSave(){clearTimeout(_saveTimer);_saveTimer=setTimeout(()=>{localStorage.setItem("children",JSON.stringify(children));},300);}
function sauver(){try{localStorage.setItem("children",JSON.stringify(children));alert("‚úÖ Param√®tres enregistr√©s");}catch(e){alert("‚ùå Erreur : "+e.message);}}
function ajouterEnfant(){children.push({settings:{childName:"Nouvel enfant",rewardLow:"",rewardHigh:"",thresholdLow:30,thresholdHigh:50,rewards:{}},tasks:[]});currentChild=children.length-1;autoSave();render();}
function supprimerEnfant(idx){if(confirm("Supprimer cet enfant ?")){children.splice(idx,1);if(currentChild>=children.length)currentChild=children.length-1;autoSave();render();}}
function resetAll(){if(confirm("‚ö†Ô∏è R√©initialiser tous les enfants ?")){children=[];currentChild=0;autoSave();render();}}
function ajouterTache(cIdx){children[cIdx].tasks.push({name:"",weights:[1,1,1,1,1,0,0]});autoSave();render();}
function supprimerTache(cIdx,tIdx){children[cIdx].tasks.splice(tIdx,1);autoSave();render();}
function moveTask(cIdx,tIdx,dir){const tasks=children[cIdx].tasks;const newIdx=tIdx+dir;if(newIdx<0||newIdx>=tasks.length)return;const[moved]=tasks.splice(tIdx,1);tasks.splice(newIdx,0,moved);autoSave();render();}
function ajouterReward(cIdx) {
  const now = new Date();
  // Calcule la semaine ISO (m√©thode du jeudi)
  const d = new Date(Date.UTC(now.getFullYear(), now.getMonth(), now.getDate()));
  const day = d.getUTCDay() === 0 ? 7 : d.getUTCDay(); // lundi=1, dimanche=7
  d.setUTCDate(d.getUTCDate() + 4 - day);
  const year = d.getUTCFullYear();
  const yearStart = new Date(Date.UTC(year, 0, 1));
  const week = Math.ceil((((d - yearStart) / 86400000) + 1) / 7);

  const defaultKey = `${week}-${year}`;
  const key = prompt(`Cl√© semaine (ex: on est semaine ${defaultKey}) :`, defaultKey);
  if (key) {
    if (!children[cIdx].settings.rewards) children[cIdx].settings.rewards = {};
    children[cIdx].settings.rewards[key] = { low: "", high: "" };
    autoSave();
    render();
  }
}
function supprimerReward(cIdx,key){delete children[cIdx].settings.rewards[key];autoSave();render();}
function exporterEnfant(idx){const enfant=children[idx];if(!enfant){alert("‚ùå Aucun enfant");return;}const dataStr="data:text/json;charset=utf-8,"+encodeURIComponent(JSON.stringify(enfant,null,2));const dl=document.createElement("a");dl.setAttribute("href",dataStr);dl.setAttribute("download",(enfant.settings.childName||"enfant")+".json");dl.click();}
function importerEnfant(){const input=document.createElement("input");input.type="file";input.accept="application/json";input.onchange=e=>{const file=e.target.files[0];if(!file)return;const reader=new FileReader();reader.onload=evt=>{try{const enfant=JSON.parse(evt.target.result);children.push(enfant);currentChild=children.length-1;autoSave();render();alert("‚úÖ Import r√©ussi");}catch(err){alert("‚ùå Fichier invalide : "+err.message);}};reader.readAsText(file);};input.click();}
function setReward(cIdx,type,value){children[cIdx].settings[type]=value;autoSave();}
function setTask(cIdx,tIdx,value){children[cIdx].tasks[tIdx].name=value;autoSave();}
function setWeight(cIdx,tIdx,dayIdx,value){children[cIdx].tasks[tIdx].weights[dayIdx]=Number(value)||0;autoSave();}
function setWeekReward(cIdx,key,type,value){children[cIdx].settings.rewards[key][type]=value;autoSave();}

function render(){
  const container=document.getElementById("childrenSettings");
  const pagination=document.getElementById("pagination");
  container.innerHTML="";pagination.innerHTML="";
  if(children.length===0){container.innerHTML="<p>‚ö†Ô∏è Aucun enfant d√©fini</p>";document.getElementById("childTitle").textContent="Aucun enfant";return;}
  const child=children[currentChild];
  document.getElementById("childTitle").textContent=child.settings.childName||"Nouvel enfant";
  const card=document.createElement("div");card.className="child-card";
  card.innerHTML=`
    <div class="section">
      <h4 class="toggle-section collapsed" onclick="toggleBase(${currentChild}, this)">üë§ Param√®tres de base et par d√©faut</h4>
      <div id="base-block-${currentChild}" class="hidden">
        <div class="form-row"><label>Nom/Pr√©nom</label><input type="text" value="${child.settings.childName||""}" oninput="setReward(${currentChild},'childName',this.value)"></div>
        <div class="form-row default-thresholds form-separator"><label>üéØ Seuil 1 (%)</label><input type="number" min="0" max="100" value="${child.settings.thresholdLow??30}" oninput="setReward(${currentChild},'thresholdLow',this.value)"><label>üéØ Seuil 2 (%)</label><input type="number" min="0" max="100" value="${child.settings.thresholdHigh??50}" oninput="setReward(${currentChild},'thresholdHigh',this.value)"></div>
        <div class="form-row default-rewards form-separator"><label>üéÅ Gain 1</label><input type="text" value="${child.settings.rewardLow||""}" placeholder="Cadeau seuil 1" oninput="setReward(${currentChild},'rewardLow',this.value)"><label>üéÅ Gain 2</label><input type="text" value="${child.settings.rewardHigh||""}" placeholder="Cadeau seuil 2" oninput="setReward(${currentChild},'rewardHigh',this.value)"></div>
      </div>
    </div>
    <div class="section"><h4>üéÅ R√©compenses par semaine</h4><div id="rewards-${currentChild}"></div><button class="success-btn" onclick="ajouterReward(${currentChild})">‚ûï Ajouter une semaine</button></div>
    <div class="section"><h4>T√¢ches</h4><div id="tasks-${currentChild}"></div><div class="form-row"><button class="success-btn" onclick="ajouterTache(${currentChild})">‚ûï Ajouter une t√¢che</button><button class="danger-btn" onclick="supprimerEnfant(${currentChild})">üóë Supprimer cet enfant</button></div></div>`;
  container.appendChild(card);
  const rewardsDiv=card.querySelector("#rewards-"+currentChild);const rewards=child.settings.rewards||{};
  if(Object.keys(rewards).length===0){rewardsDiv.innerHTML="<p>‚ÑπÔ∏è Aucune r√©compense hebdo d√©finie</p>";}
  else{for(const key in rewards){const r=rewards[key];rewardsDiv.innerHTML+=`<div class="reward-week"><input type="text" value="${key}" disabled><input type="text" value="${r.low||""}" placeholder="Palier 1" oninput="setWeekReward(${currentChild},'${key}','low',this.value)"><input type="text" value="${r.high||""}" placeholder="Palier 2" oninput="setWeekReward(${currentChild},'${key}','high',this.value)"><button class="danger-btn" onclick="supprimerReward(${currentChild},'${key}')">üóë</button></div>`;}}
  const tasksDiv=card.querySelector("#tasks-"+currentChild);
  if(!child.tasks||child.tasks.length===0){tasksDiv.innerHTML="<p>‚ö†Ô∏è Aucune t√¢che d√©finie</p>";}
  else{child.tasks.forEach((t,tIdx)=>{tasksDiv.innerHTML+=`<div class="task-block"><div class="form-row task-row"><input type="text" value="${t.name}" oninput="setTask(${currentChild},${tIdx},this.value)"><button onclick="moveTask(${currentChild},${tIdx},-1)">‚¨ÜÔ∏è</button><button onclick="moveTask(${currentChild},${tIdx},1)">‚¨áÔ∏è</button><button class="danger-btn" onclick="supprimerTache(${currentChild},${tIdx})">üóë</button></div><div class="weights-grid">${["Lun","Mar","Mer","Jeu","Ven","Sam","Dim"].map((d,dayIdx)=>`<label>${d}<input type="number" min="0" value="${t.weights?.[dayIdx]??0}" oninput="setWeight(${currentChild},${tIdx},${dayIdx},this.value)"></label>`).join("")}</div></div>`;});}
  children.forEach((c,idx)=>{const item=document.createElement("div");item.className="page-item"+(idx===currentChild?" active":"");item.onclick=()=>goToChild(idx);item.innerHTML=`<div class="dot"></div><span>${c.settings.childName||`Enfant ${idx+1}`}</span>`;pagination.appendChild(item);});
}
render();
</script>
</body>
</html>