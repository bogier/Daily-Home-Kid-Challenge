<!DOCTYPE html>

<html lang="fr">
<head>
<meta charset="utf-8"/>
<title>Daily Home Kid Challenge</title>
<meta content="width=device-width, initial-scale=1.0" name="viewport"/>
<link href="manifest.json" rel="manifest"/>
<link href="style.css?v=4.4.0" rel="stylesheet"/>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
    .calendar{display:flex;align-items:center;justify-content:center;gap:8px;flex-wrap:nowrap;}
    #btnPrev,#btnNext{width:50px;height:32px;font-size:1rem;padding:0;}
    #calendar{flex:0 0 200px;text-align:center;font-weight:bold;}
    #lockMessage{text-align:center;color:#b00;font-weight:bold;margin:0.3rem 0;white-space:nowrap;}
    .btn-row{display:flex;gap:.4rem;justify-content:center;margin:.3rem 0 .2rem 0;flex-wrap:wrap;}
    /* Puzzle Vue enfant */
    .puzzle-container {
  position: relative;
  width: 90%;
  max-width: 500px;
  margin: auto;
  border: 2px solid #666;
  border-radius: 8px;
  overflow: hidden;
}
.puzzle-container::before {
  content: "";
  display: block;
  padding-top: 100%; /* carr√© responsive */
}
.puzzle-image {
  position: absolute;
  top: 0; left: 0;
  width: 100%;
  height: 100%;
  object-fit: contain;   /* garder l‚Äôimage enti√®re sans rognage */
  background: #fff;      /* couleur de fond */
}
    .puzzle-mask {
      position: absolute;
      top: 0; left: 0;
      width: 100%; height: 100%;
      display: grid;
      grid-template-columns: repeat(5, 1fr); /* ajust√© dynamiquement au run */
      grid-auto-rows: 1fr;
    }
    /* Pi√®ces fun et color√©es */
    .puzzle-piece {
      border-radius: 6px;
      margin: 1px;
      transition: opacity 0.6s ease, transform 0.3s ease;
      box-shadow: 0 1px 3px rgba(0,0,0,0.2);
    }
    .puzzle-piece:nth-child(3n) {
      background: linear-gradient(135deg, #36d1dc, #5b86e5); /* bleu */
    }
    .puzzle-piece:nth-child(3n+1) {
      background: linear-gradient(135deg, #56ab2f, #a8e063); /* vert */
    }
    .puzzle-piece:nth-child(3n+2) {
      background: linear-gradient(135deg, #ff416c, #ff4b2b); /* rose/rouge */
    }
    .puzzle-piece.revealed {
      opacity: 0;
      transform: scale(0.7) rotate(10deg);
    }
	.week-info { font-weight: normal; }   /* non-courant = pas en gras */
    .week-current { font-weight: 700; }   /* semaine courante = en gras */

  </style>
<script>
// --- Seeded RNG helpers (stable randomization per enfant/semaine) ---
function xmur3(str) {
  for(var i = 0, h = 1779033703 ^ str.length; i < str.length; i++) {
    h = Math.imul(h ^ str.charCodeAt(i), 3432918353);
    h = h << 13 | h >>> 19;
  }
  return function() {
    h = Math.imul(h ^ (h >>> 16), 2246822507);
    h = Math.imul(h ^ (h >>> 13), 3266489909);
    return (h ^= h >>> 16) >>> 0;
  }
}
function mulberry32(a) {
  return function() {
    var t = a += 0x6D2B79F5;
    t = Math.imul(t ^ t >>> 15, t | 1);
    t ^= t + Math.imul(t ^ t >>> 7, t | 61);
    return ((t ^ t >>> 14) >>> 0) / 4294967296;
  }
}
function seededShuffle(n, seedStr){
  const order = Array.from({length:n}, (_,i)=>i);
  const seedGen = xmur3(seedStr);
  const rand = mulberry32(seedGen());
  for(let i=n-1;i>0;i--){
    const j = Math.floor(rand()*(i+1));
    [order[i], order[j]] = [order[j], order[i]];
  }
  return order;
}
</script></head>
<body>
<header>
<div class="nav-left">
<nav id="navMenu" style="display:flex;">
<a aria-label="Accueil" href="index.html"><svg aria-hidden="true" class="icon" viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M3 10.5L12 3l9 7.5"></path><path d="M5 10v10h14V10"></path><path d="M9 20v-6h6v6"></path></svg></a>
<a aria-label="Param√®tres" href="settings.html"><svg aria-hidden="true" class="icon" viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><circle cx="12" cy="12" r="3"></circle><path d="M19.4 15a7.8 7.8 0 0 0 .1-2l2-1.1-1.4-2.4-2.2.6a7.8 7.8 0 0 0-1.7-1l-.3-2.3h-2.8l-.3 2.3a7.8 7.8 0 0 0-1.7 1l-2.2-.6L2.5 12l2 1.1a7.8 7.8 0 0 0 .1 2L2.5 16l1.4 2.4 2.2-.6a7.8 7.8 0 0 0 1.7 1l.3 2.2h2.8l.3-2.2a7.8 7.8 0 0 0 1.7-1l2.2.6 1.4-2.4-2-.9Z"></path></svg></a>
<a aria-label="√Ä propos" href="about.html"><svg aria-hidden="true" class="icon" viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><circle cx="12" cy="12" r="10"></circle><line x1="12" x2="12" y1="8" y2="8"></line><line x1="12" x2="12" y1="12" y2="17"></line></svg></a>
<a aria-label="Installer l‚Äôapp" href="install.html"><svg aria-hidden="true" class="icon" viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M12 3v10"></path><polyline points="8 11 12 15 16 11"></polyline><path d="M4 20h16"></path></svg></a>
</nav>
</div>
<button class="toggle-dark" onclick="toggleDarkMode()"><span aria-hidden="true" class="icon-sun"><svg aria-hidden="true" class="icon" viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><circle cx="12" cy="12" r="4"></circle><line x1="12" x2="12" y1="2" y2="5"></line><line x1="12" x2="12" y1="19" y2="22"></line><line x1="2" x2="5" y1="12" y2="12"></line><line x1="19" x2="22" y1="12" y2="12"></line><line x1="4.2" x2="6.3" y1="4.2" y2="6.3"></line><line x1="17.7" x2="19.8" y1="17.7" y2="19.8"></line><line x1="17.7" x2="19.8" y1="6.3" y2="4.2"></line><line x1="4.2" x2="6.3" y1="19.8" y2="17.7"></line></svg></span><span aria-hidden="true" class="icon-moon"><svg aria-hidden="true" class="icon" viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M21 12.8A9 9 0 1 1 11.2 3 7 7 0 0 0 21 12.8z"></path></svg></span></button>
</header>
<div class="calendar">
<button class="btn btn-small btn-icon" id="btnPrev" onclick="changerSemaine(-1)">‚óÄ</button>
<div id="calendar"></div>
<button class="btn btn-small btn-icon" id="btnNext" onclick="changerSemaine(1)">‚ñ∂</button>
</div>
<p id="lockMessage"></p>
<main>
<p id="modeLabel" style="text-align:center;font-weight:bold;margin:0.5rem 0;"></p>
<div class="btn-row">
<button aria-label="Semaine" class="btn btn-small" data-mode="semaine" onclick="setVue('semaine')" title="Semaine"><svg aria-hidden="true" class="icon" fill="none" viewbox="0 0 24 24"><rect height="18" rx="2" width="18" x="3" y="4"></rect><line x1="16" x2="16" y1="2" y2="6"></line><line x1="8" x2="8" y1="2" y2="6"></line><line x1="3" x2="21" y1="10" y2="10"></line></svg></button>
<button aria-label="Globale" class="btn btn-small" data-mode="globale" onclick="setVue('globale')" title="Globale"><svg aria-hidden="true" class="icon fill" viewbox="0 0 24 24"><rect height="7" rx="1" width="7" x="3" y="3"></rect><rect height="7" rx="1" width="7" x="14" y="3"></rect><rect height="7" rx="1" width="7" x="3" y="14"></rect><rect height="7" rx="1" width="7" x="14" y="14"></rect></svg></button>
<button aria-label="Jour" class="btn btn-small" data-mode="jour" onclick="setVue('jour')" title="Jour"><svg aria-hidden="true" class="icon" viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><circle cx="12" cy="12" r="4"></circle><line x1="12" x2="12" y1="2" y2="5"></line><line x1="12" x2="12" y1="19" y2="22"></line><line x1="2" x2="5" y1="12" y2="12"></line><line x1="19" x2="22" y1="12" y2="12"></line><line x1="4.2" x2="6.3" y1="4.2" y2="6.3"></line><line x1="17.7" x2="19.8" y1="17.7" y2="19.8"></line><line x1="17.7" x2="19.8" y1="6.3" y2="4.2"></line><line x1="4.2" x2="6.3" y1="19.8" y2="17.7"></line></svg></button>
<button aria-label="R√©sultat" class="btn btn-small" data-mode="avancee" onclick="setVue('avancee')" title="R√©sultat"><svg aria-hidden="true" class="icon" fill="none" viewbox="0 0 24 24"><polyline points="3,17 9,11 13,15 21,7"></polyline><line x1="3" x2="21" y1="21" y2="21"></line><line x1="3" x2="3" y1="21" y2="17"></line></svg></button>
</div>
<div class="child-nav" style="flex-direction:column;gap:.1rem;">
<div class="week-rewards" id="weekRewards"></div>
<div class="separator"></div><div style="display:flex;align-items:center;justify-content:center;gap:.6rem;">
<button aria-label="Enfant pr√©c√©dent" class="btn btn-small btn-icon" onclick="prevChild()" title="Enfant pr√©c√©dent"><svg aria-hidden="true" class="icon" fill="none" viewbox="0 0 24 24"><polyline points="15 18 9 12 15 6"></polyline></svg></button>
<h2 id="childTitle">T√¢ches de ...</h2>
<button aria-label="Enfant suivant" class="btn btn-small btn-icon" onclick="nextChild()" title="Enfant suivant"><svg aria-hidden="true" class="icon" fill="none" viewbox="0 0 24 24"><polyline points="9 18 15 12 9 6"></polyline></svg></button> <button aria-label="R√©compenses" class="btn btn-small btn-icon" onclick="toggleRecompenses()" title="R√©compenses"><svg aria-hidden="true" class="icon" viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M8 21h8"></path><path d="M9 17h6v4H9z"></path><path d="M8 5h8v5a4 4 0 0 1-8 0V5z"></path><path d="M6 7H4a3 3 0 0 0 3 3"></path><path d="M18 7h2a3 3 0 0 1-3 3"></path></svg></button>
</div>
</div><div id="jourBadge" style="text-align:center; font-weight:bold; margin:0.5rem 0; display:none;"></div>
<!-- Vue enfant puzzle -->
<div id="vueEnfant" style="display:none;text-align:center;margin:1rem 0;">
<h3 id="vueEnfantTitle"></h3>

<div style="margin:0.5rem 0;">
  <button class="btn btn-small" onclick="uploadImage()">üì∑</button>
  <button class="btn btn-small" id="btnDeleteImage" type="button" title="Supprimer l‚Äôimage">üóëÔ∏è</button>
  <input type="file" id="imageInput" accept="image/*" style="display:none;" onchange="handleImageUpload(event)">
</div>

<div class="puzzle-container">
<img class="puzzle-image" src="img/puzzle.png"/>
<div class="puzzle-mask" id="puzzleMask"></div>
</div>
</div>
<div class="table-wrapper">
<table id="tasksTable">
<thead id="tasksHeader"></thead>
<tbody id="tasks"></tbody>
</table>
</div>
<div class="btn-group" style="text-align:center;display:flex;flex-wrap:wrap;gap:.5rem;justify-content:center;">
<button class="btn" onclick="toggleHistorique()">üìñ Historique</button>
<button class="btn btn-warning" onclick="resetSemaine()">‚ôªÔ∏è R√©initialiser la semaine</button>
</div>
<div class="result" id="resultat"></div>
<!-- v4.3.1 : Bonus/Malus -->
<div class="bonus-malus">
<label>Bonus : <input id="bonusInput" step="1" type="number" value="0"/></label>
<label>Malus : <input id="malusInput" step="1" type="number" value="0"/></label>
</div>
<div class="progress-container"><div class="progress-bar" id="progressBar"></div></div>
<div id="historique" style="display:none;">
<h2>üìñ Historique</h2>
<div class="tabs" style="text-align:center;margin-bottom:.5rem;">
<button class="btn btn-small" id="tabSemaine" onclick="changerVue('semaine')">semaines</button>
<button class="btn btn-small" id="tabGlobale" onclick="changerVue('globale')">graphique </button>
<button class="btn btn-danger btn-small" onclick="resetHistorique()">üîÑ R√©initialiser l‚Äôhistorique</button>
</div>
<table>
<thead><tr><th>Semaine</th><th>% R√©alis√©</th><th>R√©compense</th><th>Palier</th></tr></thead>
<tbody id="historiqueBody"></tbody>
</table>
<div id="chartContainer" style="display:none;height:280px;margin-top:16px;">
<canvas id="historyChart"></canvas>
</div>
</div>
<div style="text-align:center;margin-top:1rem;">
<button class="btn" id="installBtn" style="display:none;">üì≤ Installer l‚Äôapp</button>
</div>
</main>
<script>

/* üåô Dark mode */
if(window.matchMedia('(prefers-color-scheme: dark)').matches)document.body.classList.add("dark");
if(localStorage.getItem("darkMode")==="true")document.body.classList.add("dark");
function toggleDarkMode(){document.body.classList.toggle("dark");localStorage.setItem("darkMode",document.body.classList.contains("dark"));}

/* Menu */


/* Enfants */
let children=JSON.parse(localStorage.getItem("children"))||[];
let currentChild=0;
function getChild(){return children[currentChild];}
function saveChildren(){localStorage.setItem("children",JSON.stringify(children));}
function bootstrapIfEmpty(){
  if(!Array.isArray(children)||children.length===0){
    children=[{settings:{childName:"Mon enfant",rewardLow:"",rewardHigh:"",thresholdLow:30,thresholdHigh:50,rewards:{}},tasks:[],notes:{},history:[]}];
    saveChildren();
  }
}
bootstrapIfEmpty();
function prevChild(){if(currentChild>0){currentChild--;majUI();}}
function nextChild(){if(currentChild<children.length-1){currentChild++;majUI();}}


/* Dates */
function formatDateFR(d){return d.toLocaleDateString('fr-FR',{day:'2-digit',month:'2-digit'});}
function getMonday(d){d=new Date(d);const day=d.getDay();const diff=d.getDate()-day+(day==0?-6:1);return new Date(d.setDate(diff));}
function getSunday(m){const s=new Date(m);s.setDate(m.getDate()+6);return s;}
function getWeekNumber(d){d=new Date(Date.UTC(d.getFullYear(),d.getMonth(),d.getDate()));d.setUTCDate(d.getUTCDate()+4-(d.getUTCDay()||7));const yearStart=new Date(Date.UTC(d.getUTCFullYear(),0,1));return Math.ceil((((d-yearStart)/86400000)+1)/7);}
let currentDate=new Date();
function getWeekData(){const m=getMonday(currentDate),s=getSunday(m);return{num:getWeekNumber(m),annee:m.getFullYear(),lundi:formatDateFR(m),dim:formatDateFR(s)};}
function getWeekKey(){const w=getWeekData();return `${w.num}-${w.annee}`;}
function getCurrentWeekKey(){const today=new Date();return `${getWeekNumber(today)}-${today.getFullYear()}`;}
function afficherCalendrier(){
  const w=getWeekData();
  const cal=document.getElementById("calendar");
  if(cal){cal.innerHTML=`<div class="week-info">Semaine ${w.num} ${w.annee} ‚Äî ${w.lundi} ‚Üí ${w.dim}</div>`;}
  const lockMsg=document.getElementById("lockMessage");
  if(lockMsg){
    if(getWeekKey()!==getCurrentWeekKey()){lockMsg.textContent="üîí Semaine verrouill√©e (lecture seule)";}
    else {lockMsg.textContent="";}
  }
}
function changerSemaine(delta){currentDate.setDate(currentDate.getDate()+delta*7);majUI();}
function retourAujourdHui(){currentDate=new Date();majUI();}
/* Vue saisie */
let modeSaisie = 'semaine';

/* R√©compenses */
function setVue(mode) {
  modeSaisie = mode;
  majTableau();
  calculer();
  // Active button by data-mode (robust)
  try {
    document.querySelectorAll(".btn-row button").forEach(btn => btn.classList.remove("active"));
    const btn = document.querySelector(`.btn-row button[data-mode="${mode}"]`);
    if (btn) { btn.classList.add("active"); }
  } catch(e) { /* ignore */ }
  // Mode label
  const labels = {semaine:"Semaine", globale:"Globale", jour:"Jour", avancee:"R√©sultat"};
  const ml = document.getElementById("modeLabel");
  if (ml) ml.textContent = labels[mode] || "";
}
function afficherRecompensesSemaine(){
  const key=getWeekKey();
  const c=getChild();
  const weekRewards=c.settings.rewards?.[key]||{};
  const low=(weekRewards.low&&weekRewards.low.trim()!=="")?weekRewards.low:(c.settings.rewardLow||"‚ùå Aucune");
  const high=(weekRewards.high&&weekRewards.high.trim()!=="")?weekRewards.high:(c.settings.rewardHigh||"‚ùå Aucune");
  document.getElementById("weekRewards").innerHTML = `üéÅ <b>R√©compenses semaine ${key}</b><br>
  Palier 1 (‚â• ${c.settings.thresholdLow||30}%) : <span>${low}</span><br>
  Palier 2 (‚â• ${c.settings.thresholdHigh||50}%) : <span>${high}</span>`;
}
function toggleRecompenses(){
  const el=document.getElementById("weekRewards");
  const newState = (el.style.display==="none")?"block":"none";
  el.style.display = newState;
  localStorage.setItem('showRewards', newState === 'block' ? '1' : '0');
}

/* Tableau */
const tasksHeader=document.getElementById("tasksHeader");
const tasksBody=document.getElementById("tasks");
const days=["Lun","Mar","Mer","Jeu","Ven","Sam","Dim"];

function majTableau(){
  tasksHeader.innerHTML="";
  tasksBody.innerHTML="";
  document.getElementById("vueEnfant").style.display = "none";

  if(modeSaisie === "semaine"){ // ancien "jour"
    let headerRow = `<tr><th>T√¢che</th>`;
    days.forEach(d=>headerRow+=`<th>${d}</th>`);
    headerRow+=`</tr>`;
    tasksHeader.innerHTML = headerRow;

  } else if(modeSaisie === "globale"){ // ancien "semaine"
    tasksHeader.innerHTML = `<tr><th>T√¢che</th><th>Semaine</th></tr>`;

  } else if(modeSaisie === "jour"){ // ancien "detail"
    const today = new Date();
    const jourIndex = today.getDay();
    const jours = ["Dim","Lun","Mar","Mer","Jeu","Ven","Sam"];
    const jourNom = jours[jourIndex];
    tasksHeader.innerHTML = `<tr><th>T√¢che</th><th>${jourNom}</th></tr>`;

  } else if(modeSaisie === "avancee"){ // ancien "enfant"
    document.getElementById("vueEnfant").style.display = "block";
    document.getElementById("vueEnfantTitle").textContent =
      getChild().settings.childName || "Mon enfant";

    // Image sp√©cifique par enfant = "Nom_Enfant.png" avec fallback
    const childName = (getChild().settings.childName || "MonEnfant").trim();
    const safeName = childName.replace(/\s+/g,"_");
    const img = document.querySelector("#vueEnfant .puzzle-image");
    img.src = getStoredImage() || `img/${safeName}.png`;
    img.onerror = () => { img.src = "img/puzzle.png"; };

    majPuzzle();
    document.getElementById("modeLabel").textContent = "R√©sultat";

    // Pas de tableau dans cette vue
    // Badge masqu√©
    const badgeZone = document.getElementById("jourBadge");
    if(badgeZone) badgeZone.style.display = "none";
    return;
  }

  // Affichage des lignes de t√¢ches (pour les 3 autres vues)
  const notes = getChild().notes?.[getWeekKey()] || {};
  const disable = (getWeekKey() !== getCurrentWeekKey()) ? "disabled" : "";

  if(!getChild().tasks || getChild().tasks.length===0){
    const tr = document.createElement("tr");
    tr.innerHTML = `<td colspan="2">‚ö†Ô∏è Aucune t√¢che d√©finie</td>`;
    tasksBody.appendChild(tr);
  } else {
    getChild().tasks.forEach((t,i)=>{
      const tr=document.createElement("tr");
      let row = `<td>${t.name}</td>`;

      if(modeSaisie === "semaine"){ // ancien "jour"
        days.forEach((d,dayIdx)=>{
          const checked = notes[i]?.[dayIdx] ? "checked" : "";
          row+=`<td><input type="checkbox" data-task="${i}" data-day="${dayIdx}" ${checked} ${disable}></td>`;
        });

      } else if(modeSaisie === "globale"){ // ancien "semaine"
        const checked = notes[i]?.some(v=>v===1) ? "checked" : "";
        row+=`<td><input type="checkbox" data-task="${i}" data-week="1" ${checked} ${disable}></td>`;

      } else if(modeSaisie === "jour"){ // ancien "detail"
        const today = new Date();
        const jourIndex = today.getDay();
        const dayIdx = (jourIndex===0)?6:(jourIndex-1);
        const checked = notes[i]?.[dayIdx] ? "checked" : "";
        row+=`<td><input type="checkbox" data-task="${i}" data-day="${dayIdx}" ${checked} ${disable}></td>`;
      }

      tr.innerHTML = row;
      tasksBody.appendChild(tr);
    });
  }

  // Sauvegarde automatique au clic
  document.querySelectorAll("#tasks input[type=checkbox]").forEach(cb=>{
    cb.addEventListener("change",()=>{sauverNotes();calculer();});
  });

  // Label et badge
  const modeLabel = document.getElementById("modeLabel");
  const badgeZone = document.getElementById("jourBadge");
  if(modeSaisie === "semaine"){ // ancien "jour"
    modeLabel.textContent = "semaines";
    if(badgeZone) badgeZone.style.display = "none";
  } else if(modeSaisie === "globale"){ // ancien "semaine"
    modeLabel.textContent = "graphique ";
    if(badgeZone) badgeZone.style.display = "none";
  } else if(modeSaisie === "jour"){ // ancien "detail"
    modeLabel.textContent = "Jour";
    if(badgeZone){
      const today = new Date();
      const joursLong = ["Dimanche","Lundi","Mardi","Mercredi","Jeudi","Vendredi","Samedi"];
      badgeZone.textContent = "üìå Jour en cours : " + joursLong[today.getDay()];
      badgeZone.style.display = "block";
    }
  }
}

/* Sauvegarde des notes pour les 3 vues */
function sauverNotes(){
  const key = getWeekKey();
  if(!getChild().notes) getChild().notes = {};

  if(modeSaisie === "semaine"){ // ancien "jour"
    // Vue rapide ‚Üí sauvegarde par jour complet
    getChild().notes[key] = getChild().tasks.map((t,i)=>
      days.map((d,dayIdx)=>
        document.querySelector(`input[data-task='${i}'][data-day='${dayIdx}']`)?.checked?1:0
      )
    );

  } else if(modeSaisie === "globale"){ // ancien "semaine"
    // Vue d√©tail ‚Üí une case pour la semaine enti√®re
    getChild().notes[key] = getChild().tasks.map((t,i)=>
      days.map(()=>document.querySelector(`input[data-task='${i}'][data-week='1']`)?.checked?1:0)
    );

  } else if(modeSaisie === "jour"){ // ancien "detail"
    // Vue jour ‚Üí met √† jour uniquement le jour en cours
    const today = new Date();
    const jourIndex = today.getDay();
    const dayIdx = (jourIndex===0)?6:(jourIndex-1);

    if(!getChild().notes[key]){
      getChild().notes[key] = getChild().tasks.map(() => [0,0,0,0,0,0,0]);
    }

    getChild().tasks.forEach((t,i)=>{
      const checked = document.querySelector(`input[data-task='${i}'][data-day='${dayIdx}']`)?.checked?1:0;
      getChild().notes[key][i][dayIdx] = checked;
    });
  }

  saveChildren();
}



function majPuzzle(){

  const c = getChild();
  const key = getWeekKey();

  if(!c.notes) c.notes = {};
  if(!c.notes[key]){
    c.notes[key] = (c.tasks || []).map(() => [0,0,0,0,0,0,0]);
  }

  const notes = c.notes[key];
  let total=0, done=0;

  (c.tasks||[]).forEach((t,i)=>{
    (t.weights||[]).forEach((w=0,d)=>{
      total += Number(w)||0;
      const val = (notes?.[i]?.[d]) || 0;
      done += (val ? Number(w)||0 : 0);
    });
  });

  // Bonus/Malus
  const bm=getBonusMalus();
  done += (bm?.bonus||0);
  done -= (bm?.malus||0);
  if(done<0) done=0;
  if(done>total) done=total;

  // UI de l'image / masque
  const container=document.querySelector(".puzzle-container");
  const mask=document.querySelector(".puzzle-mask");
  if(!container || !mask) return;

  mask.innerHTML = "";
  if(total === 0){
    mask.innerHTML = "<p style='color:#666;'>‚ö†Ô∏è Pas de t√¢ches d√©finies</p>";
    return;
  }

  // Puzzle carr√© complet
  const cols = Math.ceil(Math.sqrt(total));
  const totalCells = cols * cols;
  mask.style.gridTemplateColumns = `repeat(${cols},1fr)`;

  // Ordre al√©atoire stable par enfant + semaine
  const childKey = (c.name || c.id || "child") + "|" + key + "|v4.6.16";
  const order = seededShuffle(totalCells, childKey);
  const revealSet = new Set(order.slice(0, done));

  // Cas sp√©cial : toutes les t√¢ches faites ‚Üí tout r√©v√©l√©
  const allDone = (done === total);

  for(let i=0;i<totalCells;i++){
    const piece = document.createElement("div");

    if(allDone){
      piece.className = "puzzle-piece revealed";
    } else {
      if(i < total){
        piece.className = "puzzle-piece" + (revealSet.has(i) ? " revealed" : "");
      } else {
        piece.className = "puzzle-piece"; // neutre non r√©v√©l√©e
      }
    }

    mask.appendChild(piece);
  }

}



/* v4.3.1 : Bonus/Malus persist√©s (cl√© locale par enfant + semaine) */
function bmKey(){ return `bm:${currentChild}:${getWeekKey()}`; }
function loadBonusMalus(){
  const raw = localStorage.getItem(bmKey());
  let b=0,m=0;
  if(raw){ try{ const o=JSON.parse(raw); b=Number(o.bonus)||0; m=Number(o.malus)||0; }catch{} }
  document.getElementById("bonusInput").value = b;
  document.getElementById("malusInput").value = m;
  return {bonus:b, malus:m};
}
function getBonusMalus(){
  const bonus=parseInt(document.getElementById("bonusInput")?.value)||0;
  const malus=parseInt(document.getElementById("malusInput")?.value)||0;
  return {bonus, malus};
}
function saveBonusMalus(){
  const bm = getBonusMalus();
  localStorage.setItem(bmKey(), JSON.stringify(bm));
}

/* Calcul + historique */
function calculer(){
  const notes=getChild().notes?.[getWeekKey()]||[];
  let total=0,done=0;
  getChild().tasks.forEach((t,i)=>{
    (t.weights||[]).forEach((w=0,d)=>{
      total+=Number(w)||0;
      if(notes[i]?.[d]) done+=Number(w)||0;
    });
  });

  // Bonus/Malus
  const bm=getBonusMalus();
  done += bm.bonus;
  done -= bm.malus;
  if(done<0) done=0;

  const pct=total?(done/total*100):0;

  const c=getChild();
  const weekRewards=c.settings.rewards?.[getWeekKey()]||{};
  const low=(weekRewards.low&&weekRewards.low.trim()!=="")?weekRewards.low:(c.settings.rewardLow||"");
  const high=(weekRewards.high&&weekRewards.high.trim()!=="")?weekRewards.high:(c.settings.rewardHigh||"");

  // Seuils
  let tLow = parseInt(c.settings.thresholdLow);
  let tHigh = parseInt(c.settings.thresholdHigh);
  if (isNaN(tLow)) tLow = 30;
  if (isNaN(tHigh)) tHigh = 50;
  tLow = Math.min(Math.max(tLow, 0), 100);
  tHigh = Math.min(Math.max(tHigh, 0), 100);
  if (tHigh < tLow) tHigh = tLow;

  let reward="", palier="";
  if(pct >= tLow && pct < tHigh && low){
    reward=`üéÅ ${low}`; palier="Palier 1";
  } else if(pct >= tHigh && high){
    reward=`üèÜ ${high}`; palier="Palier 2";
  } else {
    reward="‚ùå Aucune r√©compense"; palier="-";
  }

  document.getElementById("resultat").innerHTML=
    `‚úÖ ${done}/${total} pts (${pct.toFixed(1)}%)<br>${reward}`;

  // Barre de progression born√©e
  const pctForBar = Math.max(0, Math.min(100, pct));
  document.getElementById("progressBar").style.width=pctForBar+"%";

  // Historique
  const week=getWeekKey();
  c.history=c.history||[];
  const existing=c.history.find(h=>h.week===week);
  if(existing){
    existing.pct=pct.toFixed(1);
    existing.reward=reward;
    existing.palier=palier;
  } else {
    c.history.push({week:week,pct:pct.toFixed(1),reward:reward,palier:palier});
  }
  saveChildren();

  // Mise √† jour visuelle du puzzle si on est en vue enfant
  if(modeSaisie==="avancee"){ majPuzzle(); }
}


/* üì∑ Gestion Image personnalis√©e par enfant/semaine */
function getImageKey() {
  const c = getChild();
  const w = getWeekData();
  const childName = (c.settings.childName || "MonEnfant").trim().replace(/\s+/g,"_");
  return `img:${childName}.${w.num}.${w.annee}`;
}

function uploadImage() {
  document.getElementById("imageInput").click();
}

function handleImageUpload(event) {
  const file = event.target.files[0];
  if (!file) return;

  const reader = new FileReader();
  reader.onload = function(e) {
    const img = new Image();
    img.onload = function() {
      const canvas = document.createElement("canvas");
      const maxSize = 800; // px
      let width = img.width;
      let height = img.height;

      if (width > height) {
        if (width > maxSize) {
          height *= maxSize / width;
          width = maxSize;
        }
      } else {
        if (height > maxSize) {
          width *= maxSize / height;
          height = maxSize;
        }
      }

      canvas.width = width;
      canvas.height = height;
      const ctx = canvas.getContext("2d");
      ctx.drawImage(img, 0, 0, width, height);

      try {
        const base64 = canvas.toDataURL("image/jpeg", 0.7); // compression
        localStorage.setItem(getImageKey(), base64);

        // üëâ Forcer le rafra√Æchissement de l'image affich√©e
        const imgEl = document.querySelector(".puzzle-image");
        if (imgEl) {
          imgEl.src = base64;
        }

        majPuzzle(); // rafra√Æchir le puzzle
      } catch (err) {
        console.error("Erreur stockage image:", err);
      }
    };
    img.src = e.target.result;
  };
  reader.readAsDataURL(file);
}

function getStoredImage() {
  const base64 = localStorage.getItem(getImageKey());
  return base64 || null;
}


/* Historique */
let historyChart = null;
function toggleHistorique(){
  const el=document.getElementById("historique");
  const isNowVisible = el.style.display!=="block";
  el.style.display = isNowVisible ? "block" : "none";
  if(isNowVisible){ changerVue('semaine'); }
}
function changerVue(mode){
  document.getElementById("tabSemaine").classList.remove("active");
  document.getElementById("tabGlobale").classList.remove("active");
  if(mode==="semaine"){document.getElementById("tabSemaine").classList.add("active");afficherHistoriqueSemaine();}
  else{document.getElementById("tabGlobale").classList.add("active");afficherHistoriqueGlobale();}
}
function afficherHistoriqueSemaine(){
  const histBody=document.getElementById("historiqueBody");histBody.innerHTML="";
  (getChild().history||[]).forEach(h=>{
    const tr=document.createElement("tr");
    tr.innerHTML=`<td>${h.week}</td><td>${h.pct}%</td><td>${h.reward}</td><td>${h.palier}</td>`;
    histBody.appendChild(tr);
  });
  document.getElementById("chartContainer").style.display="none";
  if(historyChart){ historyChart.destroy(); historyChart = null; }
}
function afficherHistoriqueGlobale(){
  const histBody=document.getElementById("historiqueBody");histBody.innerHTML="";
  const hist = (getChild().history||[]);
  if(hist.length===0){
    document.getElementById("chartContainer").style.display="none";
    if(historyChart){ historyChart.destroy(); historyChart = null; }
    return;
  }
  const labels = hist.map(h=>h.week);
  const data = hist.map(h=>Number(h.pct||0));
  document.getElementById("chartContainer").style.display="block";
  const ctx = document.getElementById("historyChart").getContext("2d");
  if(historyChart){ historyChart.destroy(); }
  historyChart = new Chart(ctx,{
    type:"line",
    data:{ labels, datasets:[{ label:"% r√©ussi", data, borderColor:"blue", fill:false, tension:0.25 }] },
    options:{ scales:{ y:{ beginAtZero:true, max:100 } }, plugins:{ legend:{display:true} } }
  });
}
function resetHistorique(){
  if(confirm("‚ö†Ô∏è Supprimer l‚Äôhistorique ?")){
    getChild().history=[];saveChildren();afficherHistoriqueSemaine();
  }
}

/* R√©init semaine (prot√©g√©e si pas la semaine courante) */
function resetSemaine(){
  if (getWeekKey() !== getCurrentWeekKey()) {
    alert("üîí Semaine verrouill√©e : impossible de r√©initialiser une semaine pass√©e ou future.");
    return;
  }
  if (!confirm("‚ôªÔ∏è R√©initialiser toutes les cases de la semaine en cours ?")) return;

  const c = getChild();
  const key = getWeekKey();
  if (!c.notes) c.notes = {};
  const daysEmpty = [0,0,0,0,0,0,0];
  c.notes[key] = (c.tasks || []).map(() => daysEmpty.slice());

  saveChildren();
  majTableau();
  calculer();
}

/* UI */

function afficherCalendrier(){
  const w = getWeekData();
  const el = document.getElementById("calendar");
  if (el) {
    const isCurrent = (getWeekKey() === getCurrentWeekKey());
    const cls = isCurrent ? "week-info week-current" : "week-info";
    el.innerHTML = `<div class="${cls}">Sem ${w.num} ${w.annee} ‚Äî ${w.lundi} ‚Üí ${w.dim}</div>`;
  }

  // (optionnel mais utile) garder le message de verrouillage
  const lockMsg = document.getElementById("lockMessage");
  if (lockMsg) {
    lockMsg.textContent = (getWeekKey() !== getCurrentWeekKey())
      ? "üîí Semaine verrouill√©e (lecture seule)"
      : "";
  }
}



function majUI(){
  document.getElementById("childTitle").textContent=getChild().settings.childName||"Mon enfant";
  afficherCalendrier();afficherRecompensesSemaine();majTableau();

  // Restitue l‚Äô√©tat d‚Äôaffichage des r√©compenses
  const showRewards = localStorage.getItem('showRewards') !== '0';
  document.getElementById("weekRewards").style.display = showRewards ? 'block' : 'none';

  // Bonus/Malus: charger puis binder
  loadBonusMalus();
  const b=document.getElementById("bonusInput");
  const m=document.getElementById("malusInput");
  b.oninput = ()=>{ saveBonusMalus(); calculer(); };
  m.oninput = ()=>{ saveBonusMalus(); calculer(); };

  calculer();
}

/* Init */
document.addEventListener('DOMContentLoaded', () => {
  try { bootstrapIfEmpty(); } catch(e) {}
  if (typeof currentDate === 'undefined' || !currentDate) { currentDate = new Date(); }
  try { setVue('jour'); } catch(e) {}
  try { majUI(); } catch(e) {}
  try { afficherCalendrier(); } catch(e) {}
});
setVue('jour');
majUI();

/* PWA : enregistrement service worker (v4.4.0) */
if ("serviceWorker" in navigator) {
  navigator.serviceWorker.register("service-worker.js")
    .then(() => console.log("‚úÖ Service Worker enregistr√© (v4.4.0)"))
    .catch(err => console.error("‚ùå SW erreur:", err));
}

/* Installation PWA */
let deferredPrompt;const installBtn=document.getElementById("installBtn");
window.addEventListener("beforeinstallprompt",e=>{e.preventDefault();deferredPrompt=e;installBtn.style.display="inline-block";});
installBtn?.addEventListener("click",async()=>{if(!deferredPrompt)return;deferredPrompt.prompt();await deferredPrompt.userChoice;deferredPrompt=null;installBtn.style.display="none";});
window.addEventListener("appinstalled",()=>{installBtn.style.display="none";});

</script>
<script>
document.addEventListener('DOMContentLoaded', () => {
  const file = (location.pathname.split('/').pop() || 'index.html').toLowerCase();
  document.querySelectorAll('header a[href]').forEach(a => {
    const target = (a.getAttribute('href') || '').split('/').pop().toLowerCase();
    if (target === file) a.classList.add('active');
  });
});


// --- Suppression image personnalis√©e (global)
window.deleteImage = function() {
  try {
    localStorage.removeItem(getImageKey());
    const img = document.querySelector(".puzzle-image");
    if (img) { img.src = "img/puzzle.png"; }
    const fi = document.getElementById("imageInput");
    if (fi) fi.value = "";
    majPuzzle();
  } catch(err) {
    console.error("Erreur suppression image:", err);
  }
};

document.addEventListener('DOMContentLoaded', () => {
  const delBtn = document.getElementById('btnDeleteImage');
  if (delBtn) {
    delBtn.addEventListener('click', window.deleteImage);
  }
});

</script>
</body>
</html>
