<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="utf-8"/>
  <title>Daily Home Kid Challenge 2.0</title>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <link rel="manifest" href="manifest.json"/>
  <link rel="stylesheet" href="style.css?v=3.5"/>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="puzzle-utils.js"></script>
</head>

<body>

  <!-- ================= HEADER ================= -->
  <header class="app-header">
    <button class="menu-btn" aria-label="Ouvrir le menu">&#9776;</button>
    <h1>Daily Home Kid Challenge</h1>
  </header>

  <!-- ================= SIDEBAR ================= -->
  <nav class="sidebar" id="sidebar">
    <h2>Mon espace Famille</h2>
    <div class="sidebar-grabber"></div>

    <div class="sidebar-content">
      <ul class="nav-list">
        <li onclick="showView('vue-jour')">🏠 Accueil</li>
        <li class="quick" onclick="addChild()">➕ Ajouter un enfant</li>
        <li class="quick" onclick="document.getElementById('importChildInput').click()">📥 Importer un enfant</li>
        <li class="quick" onclick="importExample()">🧪 Importer l'exemple</li>
        <input id="importChildInput" type="file" accept="application/json" style="display:none" onchange="handleImportChild(event)">
        <div id="childrenList"></div>
        <li onclick="resetAllChildren()">♻️ Réinitialiser les enfants</li>
        <li onclick="purgeAll()">🗑️ Purge totale</li>
      </ul>
    </div>
  </nav>

  <!-- Overlay -->
  <div id="overlay"></div>

  <!-- ================= VUES ================= -->

  <!-- Vue Jour -->
  <main class="view active" id="vue-jour">
    <div class="view-header">
      <div class="calendar">
        <button id="btnPrev">&lt;</button>
        <div class="calendar-title">
          <h2 id="weekTitle">1 Octobre 2025</h2>
        </div>
        <button id="btnNext">&gt;</button>
      </div>

      <p class="current-child" id="currentChild_day">—</p>

      <div class="tabs">
        <button class="tab active" onclick="switchTab(this,'vue-jour')">Jour</button>
        <button class="tab" onclick="switchTab(this,'vue-semaine')">Semaine</button>
        <button class="tab" onclick="switchTab(this,'vue-mois')">Mois</button>
        <!-- 🔹 Jour courant placé ici -->
        <div class="day-label" id="currentDayLabel">—</div>
      </div>
    </div>
    <div class="table-wrapper">
      <table>
        <thead><tr><th>Tâche</th><th>Statut</th></tr></thead>
        <tbody></tbody>
      </table>
    </div>
  </main>

  <!-- Vue Semaine -->
  <main class="view" id="vue-semaine">
    <div class="view-header">
      <div class="calendar">
        <button id="btnPrevWeek">&lt;</button>
        <div class="calendar-title">
          <h2 id="weekTitle_week">Semaine</h2>
        </div>
        <button id="btnNextWeek">&gt;</button>
      </div>

      <p class="current-child" id="currentChild_week">—</p>

      <div class="tabs">
        <button class="tab" onclick="switchTab(this,'vue-jour')">Jour</button>
        <button class="tab active" onclick="switchTab(this,'vue-semaine')">Semaine</button>
        <button class="tab" onclick="switchTab(this,'vue-mois')">Mois</button>
      </div>
    </div>
    <div class="table-wrapper">
      <table>
        <thead>
          <tr><th>Tâches</th><th>Lun</th><th>Mar</th><th>Mer</th><th>Jeu</th><th>Ven</th><th>Sam</th><th>Dim</th></tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </main>

  <!-- Vue Mois -->
  <main class="view" id="vue-mois">
    <div class="view-header">
      <div class="calendar">
        <button id="btnPrevMonth">&lt;</button>
        <div class="calendar-title">
          <h2 id="monthTitle">Mois</h2>
        </div>
        <button id="btnNextMonth">&gt;</button>
      </div>

      <p class="current-child" id="currentChild_month">—</p>

      <div class="tabs">
        <button class="tab" onclick="switchTab(this,'vue-jour')">Jour</button>
        <button class="tab" onclick="switchTab(this,'vue-semaine')">Semaine</button>
        <button class="tab active" onclick="switchTab(this,'vue-mois')">Mois</button>
      </div>
    </div>
    <div class="calendar-month"></div>
  </main>

  <!-- Vue Résultats -->
  <main class="view result-view" id="vue-resultats">
    <h2 id="childTitle">Résultats - Enfant</h2>
    <div class="result-actions">
      <button id="btnUploadImage" class="upload">📷</button>
      <button id="btnDeleteImage" class="delete">🗑️</button>
      <input type="file" id="imageInput" accept="image/*" style="display:none;" onchange="handleImageUpload(event)">
    </div>
    <div class="puzzle-container">
      <img src="img/puzzle.png" alt="Puzzle" class="puzzle-image">
      <div class="puzzle-mask" id="puzzleMask"></div>
    </div>
    <div class="result" id="resultat"></div>
    <div class="progress-container"><div class="progress-bar" id="progressBar"></div></div>
  </main>

  <!-- Vue Historique -->
  <main class="view" id="vue-historique">
    <h2>📖 Historique</h2>
    <table>
      <thead><tr><th>Semaine</th><th>% Réalisé</th><th>Récompense</th><th>Palier</th></tr></thead>
      <tbody id="historiqueBody"></tbody>
    </table>
    <div id="chartContainer" style="height:280px;margin-top:16px;">
      <canvas id="historyChart"></canvas>
    </div>
  </main>

<!-- Vue Nom & Avatar -->
<!-- Vue Nom & Avatar -->
<main class="view" id="vue-nom-avatar">
  <div class="view-header">
    <button onclick="openMenu()" class="back-btn">⬅ Retour</button>
    <h2>Nom & Avatar</h2>
  </div>

  <div class="param-section">

    <!-- Avatar en premier -->
    <div class="avatar-frame">
      <div class="avatar-wrapper">
        <img id="avatarPreview" src="img/default.png" alt="Avatar" class="avatar-large">
        <button type="button" class="delete-avatar-btn" onclick="deleteAvatar()">🗑️</button>
      </div>
    </div>
    <input type="file" id="inputAvatar" accept="image/*">
    <p id="avatarFileName" class="avatar-filename">Avatar par défaut</p>

    <!-- Nom -->
    <label for="inputChildName">Nom de l’enfant :</label>
    <input type="text" id="inputChildName" placeholder="Entrez le prénom">

    <!-- Âge -->
    <label for="inputChildAge">Âge :</label>
    <input type="number" id="inputChildAge" min="0" max="20" placeholder="Entrez l’âge">

    <!-- Genre -->
    <label>Genre :</label>
    <div class="gender-options">
      <label><input type="radio" name="childGender" value="fille"> Fille</label>
      <label><input type="radio" name="childGender" value="garçon"> Garçon</label>
      <label><input type="radio" name="childGender" value="non-defini" checked> Non défini</label>
    </div>

  </div>

  <div class="param-actions">
    <button onclick="majUI()">❌ Annuler</button>
  </div>
</main>



<!-- Vue Gestion des Tâches -->
<main class="view" id="vue-taches">
  <div class="view-header">
    <button onclick="openMenu()" class="back-btn">⬅ Retour</button>
    <h2>📋 Gestion des tâches</h2>
  </div>
  <div class="param-section">
    <div class="task-add">
      <input type="text" id="newTaskName" placeholder="Nouvelle tâche">
      <button class="save" onclick="addTask()">➕ Ajouter</button>
    </div>
    <ul id="taskList"></ul>
  </div>

  <div class="param-actions">
    <button onclick="majUI()">❌ Annuler</button>
  </div>
</main>


<!-- Vue Gestion des Récompenses -->
<main class="view" id="vue-recompenses">
  <div class="view-header">
    <button onclick="openMenu()" class="back-btn">⬅ Retour</button>

    <h2>🎁 Récompenses</h2>
  </div>
  <div class="param-section">
    <label for="inputRewardLow">Récompense palier 1 :</label>
    <input type="text" id="inputRewardLow" placeholder="Ex: Choisir un dessin animé">

    <label for="inputThresholdLow">Seuil (%) palier 1 :</label>
    <input type="number" id="inputThresholdLow" min="0" max="100" step="1">

    <label for="inputRewardHigh">Récompense palier 2 :</label>
    <input type="text" id="inputRewardHigh" placeholder="Ex: Sortie au parc">

    <label for="inputThresholdHigh">Seuil (%) palier 2 :</label>
    <input type="number" id="inputThresholdHigh" min="0" max="100" step="1">
  </div>

  <div class="param-actions">
    <button onclick="majUI()">❌ Annuler</button>
    <button class="save" onclick="saveRewards()">💾 Enregistrer</button>
  </div>
</main>


  <!-- ================= JS ================= -->
  <script src="index.js?v=3.5"></script>
  
<!-- 🔄 Service Worker Update Notification (DHKC bleu) -->
<script>
if ('serviceWorker' in navigator) {
  navigator.serviceWorker.register('./service-worker.js').then(reg => {
    console.log('[SW] Enregistré avec succès.');

    // 🔍 Surveille l’apparition d’une nouvelle version
    reg.addEventListener('updatefound', () => {
      const newWorker = reg.installing;
      newWorker.addEventListener('statechange', () => {
        if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
          showUpdateBanner(reg);
        }
      });
    });
  }).catch(err => {
    console.warn('[SW] Erreur d’enregistrement :', err);
  });
}

/* 📢 Bandeau d’annonce version DHKC bleue */
function showUpdateBanner(reg) {
  const banner = document.createElement('div');
  banner.id = 'sw-update-banner';
  banner.innerHTML = `
    <style>
      #sw-update-banner {
        position: fixed;
        bottom: 0;
        left: 0;
        width: 100%;
        background: linear-gradient(90deg, #1976D2, #2196F3);
        color: #fff;
        text-align: center;
        padding: 12px 16px;
        font-size: 15px;
        font-family: 'Segoe UI', Roboto, sans-serif;
        z-index: 9999;
        box-shadow: 0 -2px 8px rgba(0,0,0,0.25);
        border-top: 2px solid rgba(255,255,255,0.2);
        animation: dhkc-slide-up 0.4s ease-out;
      }
      #sw-update-banner button {
        background: #fff;
        color: #1976D2;
        border: none;
        margin-left: 10px;
        padding: 6px 14px;
        border-radius: 8px;
        cursor: pointer;
        font-weight: 600;
        font-size: 14px;
        transition: all 0.2s ease;
      }
      #sw-update-banner button:hover {
        background: #E3F2FD;
      }
      @keyframes dhkc-slide-up {
        from { transform: translateY(100%); opacity: 0; }
        to { transform: translateY(0); opacity: 1; }
      }
    </style>
    💫 Nouvelle version disponible !
    <button id="reload-btn">Recharger</button>
  `;
  document.body.appendChild(banner);

  // ⚡ Bouton "Recharger" → force la mise à jour du SW
  document.getElementById('reload-btn').addEventListener('click', () => {
    if (reg.waiting) {
      reg.waiting.postMessage({ type: 'SKIP_WAITING' });
    }
    banner.style.transition = 'opacity 0.4s ease';
    banner.style.opacity = '0';
    setTimeout(() => {
      banner.remove();
      window.location.reload();
    }, 400);
  });
}

// 🔁 Recharge automatique une fois le nouveau SW activé
let refreshing = false;
navigator.serviceWorker.addEventListener('controllerchange', () => {
  if (refreshing) return;
  refreshing = true;
  window.location.reload();
});
</script>

<!-- 🔄 Service Worker Update Notification (DHKC bleu ✨ magique) -->
<script>
if ('serviceWorker' in navigator) {
  navigator.serviceWorker.register('./service-worker.js').then(reg => {
    console.log('[SW] Enregistré avec succès.');

    // 🔍 Surveille une nouvelle version
    reg.addEventListener('updatefound', () => {
      const newWorker = reg.installing;
      newWorker.addEventListener('statechange', () => {
        if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
          showUpdateBanner(reg);
        }
      });
    });
  }).catch(err => console.warn('[SW] Erreur d’enregistrement :', err));
}

/* 📢 Bandeau bleu DHKC avec son magique */
function showUpdateBanner(reg) {
  const banner = document.createElement('div');
  banner.id = 'sw-update-banner';
  banner.innerHTML = `
    <style>
      #sw-update-banner {
        position: fixed;
        bottom: 0;
        left: 0;
        width: 100%;
        background: linear-gradient(90deg, #1976D2, #2196F3);
        color: #fff;
        text-align: center;
        padding: 12px 16px;
        font-size: 15px;
        font-family: 'Segoe UI', Roboto, sans-serif;
        z-index: 9999;
        box-shadow: 0 -2px 8px rgba(0,0,0,0.25);
        border-top: 2px solid rgba(255,255,255,0.2);
        animation: dhkc-slide-up 0.4s ease-out;
      }
      #sw-update-banner button {
        background: #fff;
        color: #1976D2;
        border: none;
        margin-left: 10px;
        padding: 6px 14px;
        border-radius: 8px;
        cursor: pointer;
        font-weight: 600;
        font-size: 14px;
        transition: all 0.2s ease;
      }
      #sw-update-banner button:hover {
        background: #E3F2FD;
      }
      @keyframes dhkc-slide-up {
        from { transform: translateY(100%); opacity: 0; }
        to { transform: translateY(0); opacity: 1; }
      }
    </style>
    ✨ Nouvelle version disponible !
    <button id="reload-btn">Recharger</button>
  `;
  document.body.appendChild(banner);

  // 🎵 Petit son "magique" (3 notes ascendantes)
  try {
    const ctx = new (window.AudioContext || window.webkitAudioContext)();
    const notes = [880, 1046, 1318]; // La5, Do6, Mi6
    let t = ctx.currentTime;

    notes.forEach((freq, i) => {
      const o = ctx.createOscillator();
      const g = ctx.createGain();
      o.type = 'triangle';
      o.frequency.setValueAtTime(freq, t + i * 0.15);
      g.gain.setValueAtTime(0.08, t + i * 0.15);
      g.gain.exponentialRampToValueAtTime(0.001, t + i * 0.15 + 0.25);
      o.connect(g).connect(ctx.destination);
      o.start(t + i * 0.15);
      o.stop(t + i * 0.15 + 0.25);
    });
  } catch (e) {
    console.warn('[SW] Son magique non pris en charge :', e);
  }

  // ⚡ Bouton "Recharger" → active la nouvelle version
  document.getElementById('reload-btn').addEventListener('click', () => {
    if (reg.waiting) reg.waiting.postMessage({ type: 'SKIP_WAITING' });
    banner.style.transition = 'opacity 0.4s ease';
    banner.style.opacity = '0';
    setTimeout(() => {
      banner.remove();
      window.location.reload();
    }, 400);
  });
}

// 🔁 Recharge automatique une fois le nouveau SW actif
let refreshing = false;
navigator.serviceWorker.addEventListener('controllerchange', () => {
  if (refreshing) return;
  refreshing = true;
  window.location.reload();
});
</script>

</body>
</html>
